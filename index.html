<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ì§€ë„ - ë¶€ë™ì‚° ë§¤ë¬¼ ì§€ë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #F9FAFB;
            font-family: 'Pretendard', 'Noto Sans KR', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #191F28;
        }
        .map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        .filter-toggle-btn {
            position: absolute;
            top: 18px;
            left: 18px;
            background: #3182F6;
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            z-index: 1100;
            box-shadow: 0 4px 16px rgba(49,130,246,0.18);
            transition: background 0.2s, box-shadow 0.2s, font-size 0.2s;
        }
        .filter-toggle-btn.collapsed {
            background: #1B64DA;
            color: #fff;
            font-size: 26px;
            padding: 20px 40px;
            box-shadow: 0 6px 24px rgba(49,130,246,0.25);
        }
        .filter-container {
            position: absolute;
            top: 32px;
            left: 32px;
            background: #FFFFFF;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(49,130,246,0.08);
            padding: 56px 24px 24px 24px; /* padding-top ëŠ˜ë¦¼ */
            max-width: 700px;
            min-width: 320px;
            z-index: 1001;
            transition: box-shadow 0.2s, opacity 0.2s, transform 0.2s;
        }
        .filter-container.collapsed {
            padding: 0;
            min-width: 0;
            max-width: 200px;
            height: 0;
            overflow: hidden;
            opacity: 0.95;
            box-shadow: none;
        }
        .filter-content { transition: max-height 0.3s, opacity 0.3s; }
        .filter-container.collapsed .filter-content { display: none; }
        .filter-row {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .filter-label {
            font-weight: 600;
            color: #333D4B;
            margin-right: 8px;
            min-width: 70px;
        }
        /* ê° í•„í„° ê·¸ë£¹ë³„ ë°°ê²½ìƒ‰ (ë” ë‹¤ì–‘í•˜ê²Œ) */
        .filter-row.search-row { background: #E8F3FF; border-radius: 10px; padding: 10px 12px; }
        .filter-row.type-row { background: #D0F5F5; border-radius: 10px; padding: 10px 12px; }
        .filter-row.region-row { background: #F3E8FF; border-radius: 10px; padding: 10px 12px; }
        .filter-row.status-row { background: #E0ECFF; border-radius: 10px; padding: 10px 12px; }
        .filter-row.price-row { background: #F9FAFB; border-radius: 10px; padding: 10px 12px; }
        .filter-row.date-row { background: #FFF7E0; border-radius: 10px; padding: 10px 12px; }
        .filter-radio-group {
            display: flex;
            gap: 8px;
        }
        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ë³„ ë°°ê²½ìƒ‰ */
        .type-row .radio-btn { background: #B2EBF4; }
        .region-row .radio-btn { background: #E1D5FA; }
        .status-row .radio-btn { background: #B3D8FF; }
        .radio-btn {
            border-radius: 8px;
            padding: 8px 18px;
            font-weight: 500;
            color: #6B7684;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            border: 2px solid transparent;
            user-select: none;
        }
        .radio-btn input[type="radio"] {
            display: none;
        }
        .radio-btn:has(input[type="radio"]:checked) {
            background: #3182F6 !important;
            color: #fff !important;
            border: 2px solid #1B64DA;
        }
        input[type="text"], input[type="number"] {
            border: 1.5px solid #E5E8EB;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 16px;
            background: #F9FAFB;
            color: #191F28;
            outline: none;
            transition: border 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border: 1.5px solid #3182F6;
            background: #E8F3FF;
        }
        #search-btn {
            background: #3182F6;
            color: #fff;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            padding: 12px 32px;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(49,130,246,0.10);
            cursor: pointer;
            transition: background 0.2s;
        }
        #search-btn:hover, #search-btn:active {
            background: #1B64DA;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .status-bar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        @media (max-width: 768px) {
            .filter-toggle-btn {
                left: 2vw;
                top: 2vw;
                font-size: 18px;
                padding: 12px 20px;
            }
            .filter-container {
                max-width: 98vw;
                min-width: 0;
                padding: 56px 6px 12px 6px;
                left: 2vw;
                top: 2vw;
            }
        }
        #passwordModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #passwordBox {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            padding: 40px 32px 32px 32px;
            min-width: 320px;
            text-align: center;
        }
        #passwordInput {
            font-size: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1.5px solid #3182F6;
            margin-bottom: 18px;
            width: 80%;
        }
        #passwordSubmit {
            background: #3182F6;
            color: #fff;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            padding: 12px 32px;
            font-size: 18px;
            cursor: pointer;
        }
        #passwordError {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <div id="passwordModal">
      <div id="passwordBox">
        <h2 style="margin-bottom:18px; color:#3182F6;">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
        <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" />
        <br/>
        <button id="passwordSubmit">í™•ì¸</button>
        <button id="changePasswordBtn" style="margin-left:12px; background:#E5E8EB; color:#3182F6; font-weight:600; border:none; border-radius:8px; padding:12px 24px; font-size:16px; cursor:pointer;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        <div id="passwordError"></div>
        <div id="changePasswordBox" style="display:none; margin-top:24px;">
          <h3 style="color:#3182F6; margin-bottom:10px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
          <input type="password" id="oldPasswordInput" placeholder="ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸" style="margin-bottom:8px; width:80%; font-size:16px; padding:8px; border-radius:6px; border:1.5px solid #3182F6;" />
          <br/>
          <input type="password" id="newPasswordInput" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="margin-bottom:8px; width:80%; font-size:16px; padding:8px; border-radius:6px; border:1.5px solid #3182F6;" />
          <br/>
          <button id="submitChangePassword" style="background:#3182F6; color:#fff; font-weight:700; border:none; border-radius:8px; padding:8px 24px; font-size:16px; cursor:pointer;">ë³€ê²½</button>
          <button id="cancelChangePassword" style="margin-left:8px; background:#E5E8EB; color:#3182F6; font-weight:600; border:none; border-radius:8px; padding:8px 18px; font-size:15px; cursor:pointer;">ì·¨ì†Œ</button>
          <div id="changePasswordError" style="color:#e74c3c; margin-top:8px; font-size:14px;"></div>
        </div>
      </div>
    </div>
    <div class="map-container">
        <div id="map"></div>
        <button class="filter-toggle-btn" id="filterToggleBtn">í•„í„° ì ‘ê¸°</button>
        <div class="filter-container" id="filterContainer">
          <div class="filter-content" id="filterContent">
            <div class="filter-row search-row">
              <input type="text" id="search-input" placeholder="ì§€ì—­ëª… ë˜ëŠ” ì£¼ì†Œë¡œ ê²€ìƒ‰ (ì˜ˆ: ì—­ì‚¼ë™, 613-21)" style="flex:1; min-width:180px;" />
            </div>
            <div class="filter-row type-row">
              <div class="filter-label">ë§¤ë¬¼ ìœ í˜•</div>
              <div class="filter-radio-group" id="type-group">
                <label class="radio-btn"><input type="radio" name="type" value="office" checked />ì‚¬ë¬´ì‹¤</label>
                <label class="radio-btn"><input type="radio" name="type" value="store" />ìƒê°€</label>
              </div>
            </div>
            <div class="filter-row region-row">
              <div class="filter-label">ì§€ì—­</div>
              <div class="filter-radio-group" id="region-group">
                <label class="radio-btn"><input type="radio" name="region" value="gangnam" checked />ê°•ë‚¨ì›”ì„¸</label>
                <label class="radio-btn"><input type="radio" name="region" value="songpa" />ì†¡íŒŒì›”ì„¸</label>
              </div>
            </div>
            <div class="filter-row status-row">
              <div class="filter-label">ë§¤ë¬¼ ìƒíƒœ</div>
              <div class="filter-radio-group" id="status-group">
                <label class="radio-btn"><input type="radio" name="status" value="ê³µí´" checked />ê³µí´</label>
                <label class="radio-btn"><input type="radio" name="status" value="ì˜¨í•˜" />ì˜¨í•˜</label>
                <label class="radio-btn"><input type="radio" name="status" value="ê° ë§¤" />ê° ë§¤</label>
              </div>
              <label style="margin-left:16px; font-weight:600; color:#3182F6; cursor:pointer; user-select:none;">
                <input type="checkbox" id="singleOnlyCheckbox" style="vertical-align:middle; margin-right:6px;" />ë§¤ë¬¼1ê°œë§Œ
              </label>
            </div>
            <div class="filter-row price-row">
              <div class="filter-label">ë³´ì¦ê¸ˆ</div>
              <input type="number" id="deposit-min" placeholder="ìµœì†Œ(ë§Œì›)" style="width:90px;" />
              <span>~</span>
              <input type="number" id="deposit-max" placeholder="ìµœëŒ€(ë§Œì›)" style="width:90px;" />
            </div>
            <div class="filter-row price-row">
              <div class="filter-label">ì›”ì„¸</div>
              <input type="number" id="rent-min" placeholder="ìµœì†Œ(ë§Œì›)" style="width:90px;" />
              <span>~</span>
              <input type="number" id="rent-max" placeholder="ìµœëŒ€(ë§Œì›)" style="width:90px;" />
            </div>
            <div class="filter-row date-row" style="background:#FFF7E0; border-radius:10px; padding:10px 12px;">
              <div class="filter-label">ë“±ë¡ì¼</div>
              <div class="filter-radio-group" id="date-group">
                <label class="radio-btn" style="background:#FFE082;"><input type="radio" name="date" value="1" />1ì¼</label>
                <label class="radio-btn" style="background:#FFD54F;"><input type="radio" name="date" value="2" />2ì¼</label>
                <label class="radio-btn" style="background:#FFCA28;"><input type="radio" name="date" value="3" />3ì¼</label>
                <label class="radio-btn" style="background:#FFC107;"><input type="radio" name="date" value="4" />4ì¼</label>
                <label class="radio-btn" style="background:#FFB300;"><input type="radio" name="date" value="5" />5ì¼</label>
                <label class="radio-btn" style="background:#FFA000;"><input type="radio" name="date" value="6" />6ì¼</label>
                <label class="radio-btn" style="background:#FF8F00;"><input type="radio" name="date" value="7" />7ì¼</label>
                <label class="radio-btn" style="background:#F9FAFB;"><input type="radio" name="date" value="" checked />ì „ì²´</label>
              </div>
            </div>
            <div class="filter-row" style="justify-content:center; gap:16px;">
              <button id="search-btn">ë§¤ë¬¼ ê²€ìƒ‰í•˜ê¸°</button>
              <button id="reset-btn" style="background:#E5E8EB; color:#333D4B; font-weight:600; border:none; border-radius:10px; padding:12px 24px; font-size:16px; margin-left:8px; cursor:pointer;">í•„í„° ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
        <div class="loading" id="loading">
            <p>ğŸ—ºï¸ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        <div class="status-bar" id="statusBar">
            ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...
        </div>
        <div style="position: absolute; top: 18px; right: 18px; background: #191F28; color: white; padding: 12px 20px; border-radius: 10px; font-size: 16px; font-weight: 600; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" id="totalCount">
            ì´ ë§¤ë¬¼: 0ê°œ
        </div>
    </div>

    <!-- ì„¤ì • íŒŒì¼ -->
    <script src="config.js"></script>
    <!-- ìŠˆí¼ë² ì´ìŠ¤ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let supabase;
        let markers = [];
        let properties = [];
        let selectedProperty = null;
        let filteredProperties = [];
        let geocodeCache = {}; // ì§€ì˜¤ì½”ë”© ìºì‹œ
        let lastLoadedRegion = 'gangnam'; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œë“œí•œ ì§€ì—­ ì¶”ì 

        // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸
        const DEFAULT_PASSWORD = 'ejxkqdnjs1';
        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(ê³ ì •)
        const ADMIN_PASSWORD = 'ejxkqdnjs88';
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        function getPagePassword() {
            return localStorage.getItem('page_password') || DEFAULT_PASSWORD;
        }
        // ë¹„ë°€ë²ˆí˜¸ ì €ì¥
        function setPagePassword(newPw) {
            localStorage.setItem('page_password', newPw);
        }

        // ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            const submit = document.getElementById('passwordSubmit');
            const errorDiv = document.getElementById('passwordError');
            const changeBtn = document.getElementById('changePasswordBtn');
            const changeBox = document.getElementById('changePasswordBox');
            const oldPwInput = document.getElementById('oldPasswordInput');
            const newPwInput = document.getElementById('newPasswordInput');
            const submitChange = document.getElementById('submitChangePassword');
            const cancelChange = document.getElementById('cancelChangePassword');
            const changeError = document.getElementById('changePasswordError');

            function tryAuth() {
                if (input.value === getPagePassword()) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                } else {
                    errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    input.value = '';
                    input.focus();
                }
            }
            submit.onclick = tryAuth;
            input.onkeydown = function(e) { if (e.key === 'Enter') tryAuth(); };
            input.focus();
            document.body.style.overflow = 'hidden';

            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ UI
            changeBtn.onclick = function() {
                changeBox.style.display = 'block';
                oldPwInput.value = '';
                newPwInput.value = '';
                changeError.textContent = '';
                oldPwInput.focus();
            };
            cancelChange.onclick = function() {
                changeBox.style.display = 'none';
            };
            submitChange.onclick = function() {
                const adminPw = oldPwInput.value;
                const newPw = newPwInput.value;
                if (!adminPw || !newPw) {
                    changeError.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';
                    return;
                }
                if (adminPw !== ADMIN_PASSWORD) {
                    changeError.textContent = 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    return;
                }
                setPagePassword(newPw);
                changeError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!';
                setTimeout(() => {
                    changeBox.style.display = 'none';
                    errorDiv.textContent = '';
                }, 1200);
            };
        });

        // ì§€ì˜¤ì½”ë”© ìºì‹œ ë¡œë“œ
        function loadGeocodeCache() {
            try {
                const cached = localStorage.getItem('geocodeCache');
                if (cached) {
                    geocodeCache = JSON.parse(cached);
                    console.log(`ì§€ì˜¤ì½”ë”© ìºì‹œ ${Object.keys(geocodeCache).length}ê°œ ë¡œë“œë¨`);
                }
            } catch (error) {
                console.warn('ì§€ì˜¤ì½”ë”© ìºì‹œ ë¡œë“œ ì‹¤íŒ¨:', error);
                geocodeCache = {};
            }
        }

        // ì§€ì˜¤ì½”ë”© ìºì‹œ ì €ì¥
        function saveGeocodeCache() {
            try {
                localStorage.setItem('geocodeCache', JSON.stringify(geocodeCache));
            } catch (error) {
                console.warn('ì§€ì˜¤ì½”ë”© ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            document.getElementById('search-btn').addEventListener('click', onFilterSearch);
            document.getElementById('filterToggleBtn').addEventListener('click', function() {
                const filterContainer = document.getElementById('filterContainer');
                const btn = document.getElementById('filterToggleBtn');
                if (filterContainer.classList.contains('collapsed')) {
                    filterContainer.classList.remove('collapsed');
                    btn.textContent = 'í•„í„° ì ‘ê¸°';
                    btn.classList.remove('collapsed');
                } else {
                    filterContainer.classList.add('collapsed');
                    btn.textContent = 'í•„í„° í¼ì¹˜ê¸°';
                    btn.classList.add('collapsed');
                }
            });
            document.getElementById('reset-btn').addEventListener('click', function() {
                // í•„í„° ì…ë ¥ê°’ ì´ˆê¸°í™”
                document.getElementById('search-input').value = '';
                document.querySelector('input[name="type"][value="office"]').checked = true;
                document.querySelector('input[name="region"][value="gangnam"]').checked = true;
                document.querySelector('input[name="status"][value="ê³µí´"]').checked = true;
                document.getElementById('singleOnlyCheckbox').checked = false; // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                document.getElementById('deposit-min').value = '';
                document.getElementById('deposit-max').value = '';
                document.getElementById('rent-min').value = '';
                document.getElementById('rent-max').value = '';
                document.querySelector('input[name="date"][value=""]').checked = true;
                
                // í•„í„° ì´ˆê¸°í™” ì‹œ ë§¤ë¬¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                filteredProperties = [];
                displayMarkersOnMap();
                updateStatus('í•„í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                document.getElementById('totalCount').textContent = 'ì´ ë§¤ë¬¼: 0ê°œ';
            });
        });

        // ë„¤ì´ë²„ ì§€ë„ API ë™ì  ë¡œë“œ
        function loadNaverMapAPI() {
            return new Promise((resolve, reject) => {
                if (window.naver && window.naver.maps) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${CONFIG.CLIENT_ID}&submodules=geocoder`;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function initializeApp() {
            try {
                updateStatus('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
                // ì§€ì˜¤ì½”ë”© ìºì‹œ ë¡œë“œ
                loadGeocodeCache();
                const configErrors = validateConfig ? validateConfig() : [];
                if (configErrors.length > 0) {
                    showError('ì„¤ì • ì˜¤ë¥˜: ' + configErrors.join(', '));
                    return;
                }
                
                // ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ
                updateStatus('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì¤‘...');
                await loadNaverMapAPI();
                supabase = window.supabase.createClient(
                    CONFIG.SUPABASE.URL,
                    CONFIG.SUPABASE.ANON_KEY
                );
                await initializeMap();
                // ì§€ë„ ì´ˆê¸°í™”ê°€ ëë‚˜ë©´ loading ë©”ì‹œì§€ ìˆ¨ê¹€
                hideLoading();
                await loadProperties();
                updateStatus('ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function initializeMap() {
            return new Promise((resolve, reject) => {
                try {
                    map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(CONFIG.NAVER_MAP.CENTER.lat, CONFIG.NAVER_MAP.CENTER.lng),
                        zoom: CONFIG.NAVER_MAP.ZOOM,
                        mapTypeControl: true,
                        mapTypeControlOptions: {
                            style: naver.maps.MapTypeControlStyle.BUTTON,
                            position: naver.maps.Position.TOP_LEFT
                        },
                        zoomControl: true,
                        zoomControlOptions: {
                            style: naver.maps.ZoomControlStyle.SMALL,
                            position: naver.maps.Position.TOP_RIGHT
                        }
                    });
                    updateStatus('ì§€ë„ ë¡œë“œ ì™„ë£Œ');
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function loadProperties() {
            try {
                updateStatus('ë§¤ë¬¼ ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                // ì„ íƒëœ ì§€ì—­ì— ë”°ë¼ ë‹¤ë¥¸ í…Œì´ë¸” ì¡°íšŒ
                const region = document.querySelector('input[name="region"]:checked').value;
                let tableName = 'ë„¤ì´ë²„ì§€ë„1'; // ê¸°ë³¸ê°’ (ê°•ë‚¨)
                
                if (region === 'songpa') {
                    // ì†¡íŒŒëŠ” supabase ì—°ê²°í•˜ì§€ ì•Šê³ , ì•„ë¬´ ë°ì´í„°ë„ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ
                    properties = [];
                    filteredProperties = [];
                    updateStatus('ì†¡íŒŒì›”ì„¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    displayMarkersOnMap();
                    document.getElementById('totalCount').textContent = 'ì´ ë§¤ë¬¼: 0ê°œ';
                    return;
                }
                
                // id ì»¬ëŸ¼ ê¸°ì¤€ key-based paginationìœ¼ë¡œ 1ë§Œê°œì”© ìµœëŒ€ 5ë§Œê°œê¹Œì§€ ë°˜ë³µí•´ì„œ ë°›ì•„ì˜¤ê¸°
                let allData = [];
                let batchSize = 5000;
                let maxCount = 100000;
                let lastId = 0;
                while (allData.length < maxCount) {
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('*')
                        .gt('id', lastId)
                        .order('id', { ascending: true })
                        .limit(batchSize);
                    if (error) {
                        if (allData.length === 0) throw error;
                        else break;
                    }
                    if (!data || data.length === 0) break;
                    allData = allData.concat(data);
                    lastId = data[data.length - 1].id;
                    if (data.length < batchSize) break;
                }
                properties = allData;
                // ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ë§¤ë¬¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                filteredProperties = [];
                updateStatus(`ë§¤ë¬¼ ${properties.length}ê°œ ë¡œë“œ ì™„ë£Œ - ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”`);
                document.getElementById('totalCount').textContent = `ì´ ë§¤ë¬¼: ${properties.length}ê°œ`;
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í•œê¸€ ê¸ˆì•¡ í‘œê¸°ë¥¼ ë§Œì› ë‹¨ìœ„ ìˆ«ìë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function parseKoreanAmount(str) {
            console.log(`[DEBUG] parseKoreanAmount ì…ë ¥: "${str}"`);
            if (!str || str === '-' || str === '0') return 0;
            
            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° (ì´ë¯¸ ë§Œì› ë‹¨ìœ„)
            if (/^\d+$/.test(str.replace(/[,\s]/g, ''))) {
                const result = parseInt(str.replace(/[,\s]/g, ''));
                console.log(`[DEBUG] ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°: ${result}`);
                return parseInt(str.replace(/[,\s]/g, ''));
            }
            
            let amount = 0;
            str = str.replace(/[,\s]/g, ''); // ì‰¼í‘œ, ê³µë°± ì œê±°
            console.log(`[DEBUG] ì •ë¦¬ëœ ë¬¸ìì—´: "${str}"`);
            
            // ì–µ ë‹¨ìœ„ ì²˜ë¦¬
            const eokMatch = str.match(/(\d+)ì–µ/);
            if (eokMatch) {
                amount += parseInt(eokMatch[1]) * 10000; // 1ì–µ = 10000ë§Œì›
                console.log(`[DEBUG] ì–µ ë‹¨ìœ„ ì¶”ê°€: ${eokMatch[1]}ì–µ = ${parseInt(eokMatch[1]) * 10000}ë§Œì›`);
            }
            
            // ì²œë§Œ ë‹¨ìœ„ ì²˜ë¦¬ (ì–µ ë’¤ì˜ ì²œ)
            const remainAfterEok = str.replace(/\d+ì–µ/, '');
            console.log(`[DEBUG] ì–µ ì œê±° í›„: "${remainAfterEok}"`);
            const cheonMatch = remainAfterEok.match(/(\d+)ì²œ/);
            if (cheonMatch) {
                amount += parseInt(cheonMatch[1]) * 1000; // 1ì²œë§Œ = 1000ë§Œì›
                console.log(`[DEBUG] ì²œ ë‹¨ìœ„ ì¶”ê°€: ${cheonMatch[1]}ì²œ = ${parseInt(cheonMatch[1]) * 1000}ë§Œì›`);
            }
            
            // ë§Œ ë‹¨ìœ„ ì²˜ë¦¬
            const manMatch = remainAfterEok.match(/(\d+)ë§Œ/);
            if (manMatch) {
                amount += parseInt(manMatch[1]); // ë§Œì› ë‹¨ìœ„ ê·¸ëŒ€ë¡œ
                console.log(`[DEBUG] ë§Œ ë‹¨ìœ„ ì¶”ê°€: ${manMatch[1]}ë§Œ = ${parseInt(manMatch[1])}ë§Œì›`);
            }
            
            // ë‹¨ìˆœ ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ì²˜ë¦¬ (ì–µ, ì²œ, ë§Œ ì œê±° í›„)
            const pureNumber = remainAfterEok.replace(/[ì–µì²œë§Œ]/g, '');
            if (pureNumber && /^\d+$/.test(pureNumber)) {
                // ë§Œ ë‹¨ìœ„ê°€ ì—†ê³  ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°ëŠ” ë§Œì› ë‹¨ìœ„ë¡œ ê°€ì •
                if (!remainAfterEok.includes('ë§Œ') && !remainAfterEok.includes('ì²œ')) {
                    amount += parseInt(pureNumber);
                    console.log(`[DEBUG] ìˆœìˆ˜ ìˆ«ì ì¶”ê°€: ${pureNumber}ë§Œì›`);
                }
            }
            
            console.log(`[DEBUG] ìµœì¢… ê²°ê³¼: ${amount}ë§Œì›`);
            return amount;
        }

        function onFilterSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            const type = document.querySelector('input[name="type"]:checked').value; // 'office' or 'store'
            const region = document.querySelector('input[name="region"]:checked').value; // 'gangnam' or 'songpa'
            const status = document.querySelector('input[name="status"]:checked').value; // 'ê³µí´', 'ì˜¨í•˜', 'ê° ë§¤'
            const dateValue = document.querySelector('input[name="date"]:checked').value; // '1'~'7' or ''
            // ë³´ì¦ê¸ˆ/ì›”ì„¸ í•„í„° ê°’ ì½ê¸°
            const depositMin = document.getElementById('deposit-min').value;
            const depositMax = document.getElementById('deposit-max').value;
            const rentMin = document.getElementById('rent-min').value;
            const rentMax = document.getElementById('rent-max').value;
            const today = new Date();
            const singleOnly = document.getElementById('singleOnlyCheckbox').checked;

            // ì§€ì—­ì´ ë³€ê²½ëœ ê²½ìš° ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            const currentRegion = document.querySelector('input[name="region"]:checked').value;
            if (currentRegion !== lastLoadedRegion) {
                lastLoadedRegion = currentRegion;
                loadProperties().then(() => {
                    filterAndDisplay();
                });
            } else {
                filterAndDisplay();
            }
            
            function filterAndDisplay() {
                let filtered = properties.filter(row => {
                    // 1. ë§¤ë¬¼ìœ í˜•: 'ì¢…ë¥˜' ì»¬ëŸ¼ì´ 'ì‚¬ë¬´ì‹¤' ë˜ëŠ” 'ìƒê°€' í¬í•¨
                    const typeCol = row.ì¢…ë¥˜ || '';
                    const typeMatch = (type === 'office' && typeCol.includes('ì‚¬ë¬´ì‹¤')) ||
                                      (type === 'store' && typeCol.includes('ìƒê°€'));

                    // 2. ê°•ë‚¨ì›”ì„¸: ëª¨ë“  ë§¤ë¬¼ (ë³„ë„ ì§€ì—­ í•„í„° ì—†ìŒ)
                    const regionMatch = true;

                    // 3. ë§¤ë¬¼ìƒíƒœ: í•´ë‹¹ ì»¬ëŸ¼ ê°’ì´ ì •í™•íˆ 'ê³µí´', 'ì˜¨í•˜', 'ê° ë§¤'ì¸ì§€
                    let statusMatch = false;
                    if (status === 'ê³µí´') {
                        statusMatch = row.ê³µí´ === 'ê³µí´';
                    } else if (status === 'ì˜¨í•˜') {
                        statusMatch = row.ì˜¨í•˜ === 'ì˜¨í•˜';
                    } else if (status === 'ê° ë§¤') {
                        statusMatch = (typeof row.ê° ë§¤ === 'string') && (row.ê° ë§¤.trim() === 'ê° ë§¤');
                    } else {
                        statusMatch = true; // ê¸°ë³¸ê°’ì´ë‚˜ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ
                    }

                    // 4. ë“±ë¡ì¼: 'ë“±ë¡/í™•ì¸ì¼' ê¸°ì¤€, í•´ë‹¹ ë“±ë¡ì¼ë§Œ ë³´ì´ê²Œ ì²˜ë¦¬
                    let dateOk = true;
                    if (dateValue) {
                        let regDate = row['ë“±ë¡/í™•ì¸ì¼'] || '';
                        regDate = regDate.replace(/[^0-9]/g, '');
                        if (regDate.length === 8) {
                            const reg = new Date(
                                parseInt(regDate.slice(0,4)),
                                parseInt(regDate.slice(4,6))-1,
                                parseInt(regDate.slice(6,8))
                            );
                            const diff = (today - reg) / (1000*60*60*24);
                            // ì •í™•íˆ Nì¼ ì „ì— ë“±ë¡ëœ ë§¤ë¬¼ë§Œ í‘œì‹œ
                            const targetDays = parseInt(dateValue);
                            dateOk = Math.floor(diff) === targetDays - 1;
                        } else {
                            dateOk = false; // ë‚ ì§œ í˜•ì‹ì´ ì´ìƒí•˜ë©´ í•„í„°ì—ì„œ ì œì™¸
                        }
                    }

                    // 5. ë³´ì¦ê¸ˆ í•„í„°ë§
                    let depositOk = true;
                    if (depositMin || depositMax) {
                        const deposit = parseKoreanAmount(row.ì „ì„¸ê¸ˆ || '0');
                        if (depositMin && deposit < parseFloat(depositMin)) depositOk = false;
                        if (depositMax && deposit > parseFloat(depositMax)) depositOk = false;
                    }

                    // 6. ì›”ì„¸ í•„í„°ë§
                    let rentOk = true;
                    if (rentMin || rentMax) {
                        const rent = parseKoreanAmount(row.ì›”ì„¸ || '0');
                        if (rentMin && rent < parseFloat(rentMin)) rentOk = false;
                        if (rentMax && rent > parseFloat(rentMax)) rentOk = false;
                    }

                    // 7. í‚¤ì›Œë“œ(ì£¼ì†Œ/ë™/ê±´ë¬¼ëª…/ë§¤ë¬¼ëª…)
                    const keywordMatch = !keyword || (
                        (row.ì£¼ì†Œ && row.ì£¼ì†Œ.includes(keyword)) ||
                        (row.ë™ && row.ë™.includes(keyword)) ||
                        (row.ê±´ë¬¼ëª… && row.ê±´ë¬¼ëª….includes(keyword)) ||
                        (row.ë§¤ë¬¼ëª… && row.ë§¤ë¬¼ëª….includes(keyword))
                    );

                    return typeMatch && regionMatch && statusMatch && dateOk && depositOk && rentOk && keywordMatch;
                });

                // ë§¤ë¬¼1ê°œë§Œ ì²´í¬ ì‹œ, ì£¼ì†Œë³„ë¡œ 1ê°œë§Œ ë‚¨ê¸°ê¸°
                if (singleOnly) {
                    // ì£¼ì†Œë³„ ê·¸ë£¹í™”
                    const addressCount = {};
                    filtered.forEach(row => {
                        const addr = row.ì£¼ì†Œ || '';
                        addressCount[addr] = (addressCount[addr] || 0) + 1;
                    });
                    filtered = filtered.filter(row => addressCount[row.ì£¼ì†Œ || ''] === 1);
                }

                filteredProperties = filtered;
                displayMarkersOnMap();
                updateStatus(`ë§¤ë¬¼ ${filteredProperties.length}ê°œ í‘œì‹œ ì¤‘`);
                document.getElementById('totalCount').textContent = `ì´ ë§¤ë¬¼: ${filteredProperties.length}ê°œ`;
            }
        }

        async function displayMarkersOnMap() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // ê°™ì€ ì£¼ì†Œì˜ ë§¤ë¬¼ë“¤ì„ ê·¸ë£¹í™”
            const groupedProperties = {};
            filteredProperties.forEach((property, index) => {
                const address = property.ì£¼ì†Œ || '';
                if (!groupedProperties[address]) {
                    groupedProperties[address] = [];
                }
                groupedProperties[address].push({...property, originalIndex: index});
            });
            
            // ë°°ì¹˜ ì²˜ë¦¬ë¡œ ë§ˆì»¤ ìƒì„±
            const addresses = Object.keys(groupedProperties);
            const batchSize = 20; // í•œ ë²ˆì— ì²˜ë¦¬í•  ë§ˆì»¤ ìˆ˜ ì¦ê°€
            let processedCount = 0;
            
            async function processBatch() {
                const batch = addresses.slice(processedCount, processedCount + batchSize);
                
                for (const address of batch) {
                    const propertiesGroup = groupedProperties[address];
                    try {
                        const coords = await geocodeAddress(address);
                        if (coords) {
                            createMarker(propertiesGroup, coords, address);
                        }
                    } catch (error) {
                        console.warn(`ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${address}`, error);
                    }
                }
                
                processedCount += batchSize;
                updateStatus(`ë§ˆì»¤ ìƒì„± ì¤‘... (${Math.min(processedCount, addresses.length)}/${addresses.length})`);
                
                if (processedCount < addresses.length) {
                    // ë‹¤ìŒ ë°°ì¹˜ë¥¼ ë‹¤ìŒ í”„ë ˆì„ì— ì²˜ë¦¬
                    requestAnimationFrame(processBatch);
                } else {
                    updateStatus(`ë§ˆì»¤ ${markers.length}ê°œ í‘œì‹œ ì™„ë£Œ`);
                }
            }
            
            if (addresses.length > 0) {
                processBatch();
            } else {
                updateStatus('í‘œì‹œí•  ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        function geocodeAddress(address) {
            // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
            if (geocodeCache[address]) {
                return Promise.resolve(new naver.maps.LatLng(geocodeCache[address].lat, geocodeCache[address].lng));
            }
            
            return new Promise((resolve, reject) => {
                naver.maps.Service.geocode({
                    query: address
                }, function(status, response) {
                    if (status === naver.maps.Service.Status.ERROR) {
                        reject(new Error('Geocoding failed'));
                        return;
                    }

                    if (response.v2.meta.totalCount === 0) {
                        reject(new Error('No results found'));
                        return;
                    }

                    const result = response.v2.addresses[0];
                    const coords = new naver.maps.LatLng(result.y, result.x);
                   
                    // ìºì‹œì— ì €ì¥
                    geocodeCache[address] = { lat: result.y, lng: result.x };
                    saveGeocodeCache();
                   
                    resolve(coords);
                });
            });
        }

        function createMarker(propertiesGroup, coords, address) {
            const propertyCount = propertiesGroup.length;
            const displayText = propertyCount > 1 ? `${address} (${propertyCount}ê°œ)` : address;
            
            const marker = new naver.maps.Marker({
                position: coords,
                map: map,
                title: displayText,
                icon: {
                    content: `<div style="background: ${propertyCount > 1 ? '#FF6B35' : '#3182F6'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.18); max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayText}</div>`,
                    size: new naver.maps.Size(30, 30),
                    anchor: new naver.maps.Point(15, 15)
                }
            });
            // ì •ë³´ì°½ ìƒì„±
            const infoWindow = new naver.maps.InfoWindow({
                content: createInfoWindowContent(propertiesGroup),
                maxWidth: 320,
                backgroundColor: "#fff",
                borderColor: "#ccc",
                borderWidth: 1,
                anchorSize: new naver.maps.Size(10, 10),
                anchorSkew: true,
                anchorColor: "#fff",
                pixelOffset: new naver.maps.Point(0, -10)
            });
            marker.isOpen = false;
            naver.maps.Event.addListener(marker, 'click', function() {
                if (marker.isOpen) {
                    infoWindow.close();
                    marker.isOpen = false;
                } else {
                    markers.forEach(m => { if (m.infoWindow) { m.infoWindow.close(); m.isOpen = false; } });
                    infoWindow.open(map, marker);
                    marker.isOpen = true;
                }
            });
            marker.infoWindow = infoWindow;
            markers.push(marker);
        }

        function createInfoWindowContent(propertiesGroup) {
            const address = propertiesGroup[0].ì£¼ì†Œ || '';
            const propertyCount = propertiesGroup.length;
            
            let content = `
                <div style="padding: 18px; font-family: 'Segoe UI', sans-serif; min-width:280px; max-width:400px;">
                    <div style="font-size:16px; color:#333D4B; font-weight:700; margin-bottom:12px; border-bottom:2px solid #E5E8EB; padding-bottom:8px;">
                        ${address}
                        <span style="color:#3182F6; font-size:14px; font-weight:600; margin-left:8px;">(${propertyCount}ê°œ ë§¤ë¬¼)</span>
                    </div>
                    <div style="max-height:300px; overflow-y:auto; padding-right:8px;">
            `;
            
            propertiesGroup.forEach((property, index) => {
                // ë“±ë¡ì¼ í‘œê¸° (yyyy-mm-dd)
                let date = property['ë“±ë¡/í™•ì¸ì¼'] || property.í™•ì¸ì¼ || property.ë“±ë¡ì¼ || '';
                if (date && date.length >= 8) {
                    date = date.replace(/[^0-9]/g, '');
                    if (date.length === 8) date = `${date.slice(0,4)}-${date.slice(4,6)}-${date.slice(6,8)}`;
                }
                // ë³´ì¦ê¸ˆ(ì „ì„¸ê¸ˆ), ì›”ì„¸
                const deposit = property.ì „ì„¸ê¸ˆ || '';
                const rent = property.ì›”ì„¸ || '';
                // ë§í¬
                const link = property['ë§í¬(URL)'] || property.ë§í¬ || property.url || property.URL;
                
                content += `
                    <div style="border:1px solid #E5E8EB; border-radius:8px; padding:12px; margin-bottom:8px; background:#F9FAFB;">
                        <div style="font-size:14px; color:#191F28; font-weight:600; margin-bottom:6px;">ë§¤ë¬¼ ${index + 1}</div>
                        <div style="font-size:14px; color:#191F28; margin-bottom:4px;">ë³´ì¦ê¸ˆ <b>${deposit}</b> / ì›”ì„¸ <b>${rent}</b></div>
                        <div style="font-size:13px; color:#6B7684; margin-bottom:8px;">ë“±ë¡ì¼ : ${date || '-'}</div>
                        <div style="text-align:center;">
                            ${link && link !== 'undefined' && link !== 'null' && link.trim() !== ''
                                ? `<a href="${/^https?:\/\//i.test(link) ? link : 'https://' + link}" target="_blank" style="display:inline-block; background:#3182F6; color:#fff; font-weight:600; border-radius:6px; padding:6px 12px; text-decoration:none; font-size:13px;">ìƒì„¸ë³´ê¸°</a>`
                                : `<span style="color: #aaa; font-size: 12px;">ìƒì„¸ ë§í¬ ì—†ìŒ</span>`
                            }
                        </div>
                    </div>
                `;
            });
            
            content += `
                    </div>
                </div>
            `;
            
            return content;
        }

        function selectProperty(index) {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.property-item').forEach(item => {
                item.classList.remove('selected');
            });

            // ìƒˆë¡œìš´ ì„ íƒ
            const propertyItem = document.querySelector(`[data-index="${index}"]`);
            if (propertyItem) {
                propertyItem.classList.add('selected');
                selectedProperty = properties[index];
                
                // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                if (markers[index]) {
                    map.setCenter(markers[index].getPosition());
                    map.setZoom(15);
                }
            }
        }

        function openPropertyLink(url) {
            if (url) {
                // http(s)://ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ë¶™ì—¬ì¤Œ
                if (!/^https?:\/\//i.test(url)) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            }
        }

        function updateStatus(message) {
            document.getElementById('statusBar').textContent = message;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ì •ë³´ì°½ì—ì„œ ì‚¬ìš©)
        window.openPropertyLink = openPropertyLink;
    </script>
</body>
</html> 
